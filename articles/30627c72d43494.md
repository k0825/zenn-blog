---
title: "Lambdaã§Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒä½¿ãˆãªããªã‚‹ã®ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ç§»è¡Œã™ã‚‹ï¼ˆTerraformï¼‰"
emoji: "ğŸ"
type: "tech"
topics:
  - "aws"
  - "go"
  - "lambda"
  - "terraform"
published: true
published_at: "2023-08-27 22:21"
---

:::message
ç§ãŒæ‰€å±ã™ã‚‹ãƒ‹ãƒ•ãƒ†ã‚£æ ªå¼ä¼šç¤¾ã§åŒã˜å†…å®¹ã®è¨˜äº‹ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼
ã»ã¼åŒã˜å†…å®¹ã§ã™ãŒã€ã“ã£ã¡ã®æ–¹ãŒè‹¥å¹²ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆå¯„ã‚Šã®è©±ã‚‚å…¥ã£ã¦ã¾ã™ã€‚
https://engineering.nifty.co.jp/blog/20337
:::

# èƒŒæ™¯

8æœˆæŸæ—¥ã€AWSã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ãŒæ¥ã¾ã—ãŸã€‚ã©ã†ã‚„ã‚‰AWS Lambdaã®Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚µãƒãƒ¼ãƒˆãŒ2023/12/31ã«ã‚µãƒãƒ¼ãƒˆçµ‚äº†ã™ã‚‹ã‚‰ã—ã„ã§ã™ã€‚

```
Amazon Linux AMI ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚µãƒãƒ¼ãƒˆãŒ 2023 å¹´ 12 æœˆ 31 æ—¥ã«çµ‚äº†ã™ã‚‹ã®ã«åˆã‚ã›ã¦ã€AWS Lambda ã§ã® Go 1.x ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚µãƒãƒ¼ãƒˆã‚’çµ‚äº†ã—ã¾ã™ [1]ã€‚

Lambda ã¯ã€provided.al2 ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ã—ã¦ Go ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’å¼•ãç¶šãã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

provided.al2 ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€AWS Graviton2 ãƒ—ãƒ­ã‚»ãƒƒã‚µã®ã‚µãƒãƒ¼ãƒˆã‚„ã€ã‚ˆã‚Šå°ã•ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã‚ˆã‚Šé«˜é€Ÿãªé–¢æ•°å‘¼ã³å‡ºã—ãƒ‘ã‚¹ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªå®Ÿè£…ãªã©ã€go1.x ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«æ¯”ã¹ã¦ã„ãã¤ã‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒ–ãƒ­ã‚°è¨˜äº‹ [2] ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```

Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ Amazon Linuxã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚Amazon Linuxã®ã‚µãƒãƒ¼ãƒˆãŒ 2023/12/31ã«çµ‚äº†ã™ã‚‹ã«ä¼´ã„ã€Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚‚ã‚µãƒãƒ¼ãƒˆçµ‚äº†ã¨ãªã‚‹ã‚ˆã†ã§ã™ã€‚

Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§å‹•ä½œã—ã¦ã„ã‚‹Lambdaé–¢æ•°ã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’`provided.al2`Â ï¼ˆAmazon Linux 2ãƒ™ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼‰ã«ç§»è¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä½•æ•…Amazon Linux 2ã§Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã‚Œãªã‹ã£ãŸã‚“ã ã€‚ã€‚ã€‚ã€‚

AWSå…¬å¼ã‹ã‚‰ã®è¦‹è§£ã¨ã—ã¦ã¯ä»¥ä¸‹ã§ã™ã€‚

> Go ã¯ã€ä»–ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ã¯ç•°ãªã‚‹æ–¹æ³•ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚Go ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ãŸã‚ã€Lambda ã¯ Go ã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚`provided.al2`Â ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ã—ã¦ Go é–¢æ•°ã‚’ Lambda ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
> 

[Go ã«ã‚ˆã‚‹ Lambda é–¢æ•°ã®æ§‹ç¯‰ - AWS Lambda](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/lambda-golang.html)

ã¤ã¾ã‚Šã€ã€Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã‚“ã ã‹ã‚‰ã‚ã–ã‚ã–Goã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ã—ã¦ç”¨æ„ã™ã‚‹å¿…è¦ãªã„ã‚„ã‚ã€ã¨è¨€ã†ã“ã¨ã§ã™ã€‚

ç§ãŒå®Ÿè£…ã—ãŸLambdaã‚‚Goã§å‹•ã„ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã®ã§ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€Lambdaã‚’Terraformã§ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§Terraformã§å¤‰æ›´ã™ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¦ã„ãã¾ã™ã€‚

# å‰æ

Lambdaé–¢æ•°ã‚’Terraformã§æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™

```
. 
â”œâ”€â”€ lambda
â”‚   â”œâ”€â”€ archive // åœ§ç¸®å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ build   // ãƒã‚¤ãƒŠãƒªã‚’ä¿å­˜ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â””â”€â”€ cmd     // goã®ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚       â”œâ”€â”€ go.mod
â”‚       â”œâ”€â”€ go.sum
â”‚       â””â”€â”€ main.go
â””â”€â”€ main.tf
```

# å¤‰æ›´ã—ã¦ã¿ã‚‹

## aws_lambda_functionã®runtime

ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’go1.xã‹ã‚‰provided.al2ã«å¤‰æ›´ã—ã¾ã™ã€‚

å‰è¿°ã®é€šã‚Šã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ãŸã‚ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯Amazon Linux 2ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```diff go
resource "aws_lambda_function" "lambda" {
  function_name    = "go-lambda-sample"
  filename         = "./lambda/archive/sample.zip"
  role             = aws_iam_role.lambda_role.arn
  handler          = "sample"
-  runtime          = "go1.x"         // å¤‰æ›´å‰
+  runtime          = "provided.al2"  // å¤‰æ›´å¾Œ
  source_code_hash = data.archive_file.lambda.output_base64sha256
}
```

## ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«å

ç¾çŠ¶ã®ãƒ“ãƒ«ãƒ‰å‘¨ã‚Šã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ãŠãã‚‰ãã€Terraformã§Goã®Lambdaã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®ä¸€èˆ¬çš„ãªæ–¹æ³•ã ã¨æ€ã„ã¾ã™ã€‚

```go
resource "null_resource" "default" {
  triggers = {
    always_run = timestamp()
  }
  provisioner "local-exec" {
    command = "cd ./lambda/cmd/ && GOOS=linux GOARCH=amd64 go build -o ../build/main main.go"
  }
}

data "archive_file" "lambda" {
  type        = "zip"
  source_file = "./lambda/build/main"
  output_path = "./lambda/archive/sample.zip"

  depends_on = [null_resource.default]
}
```

ä»Šå›ã¯ã€`go build`ã®éƒ¨åˆ†ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ã¾ãŸã€å¤‰æ›´å¾Œã«åœ§ç¸®ã™ã‚‹ãŸã‚ã€åœ§ç¸®å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å¤‰æ›´ã—ã¾ã™ã€‚

ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯ã€å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«åã¯`bootstrap`ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãªã®ã§ã€`go build`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```go
cd ./lambda/cmd/ && GOOS=linux GOARCH=amd64 go build -o ../build/main main.go
â†“
cd ./lambda/cmd/ && GOOS=linux GOARCH=amd64 go build -o ../build/bootstrap main.go
```

åœ§ç¸®å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚‚`bootstrap`ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff go
data "archive_file" "lambda" {
  type        = "zip"
-  source_file = "./lambda/build/main"
+  source_file = "./lambda/build/bootstrap"
  output_path = "./lambda/archive/sample.zip"

  depends_on = [null_resource.default]
}
```

# ç¢ºèª

å®Ÿéš›ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç¢ºèªã—ã¦ã¿ã¾ã™ï¼

ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒAmazon Linux 2ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ï¼

![](https://storage.googleapis.com/zenn-user-upload/d4f8bcdd53eb-20230827.png)

ãƒ†ã‚¹ãƒˆã§ãŠè©¦ã—å®Ÿè¡Œã—ã¦ã¿ã¦ã‚‚å•é¡Œãªãå‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ï¼

![](https://storage.googleapis.com/zenn-user-upload/ca90727b8eca-20230827.png)

æ„å¤–ã¨ç°¡å˜ã«Goãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ç§»è¡Œã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

æ€¥ã„ã§ç§»è¡Œã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ãŒã€ç°¡å˜ã«ç§»è¡Œã§ãã‚‹ã®ã§æ—©ã‚ã«ç§»è¡Œã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼

# GitHub

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã«å…¬é–‹ã—ã¦ã„ã¾ã™ï¼
https://github.com/k0825/go-lambda-al2-sample