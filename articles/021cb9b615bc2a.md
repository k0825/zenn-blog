---
title: "ECS Scheduled Taskã§å®šæœŸå®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ“…"
type: "tech"
topics:
  - "aws"
  - "terraform"
  - "ecs"
  - "eventbridge"
published: true
published_at: "2023-11-03 15:15"
---

ä»Šå›ã¯ECS Scheduled Taskï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ï¼‰ã‚’ä½¿ã£ã¦å®šæœŸå®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

AWSå…¬å¼ãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã§ã™ã€‚

[ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ - Amazon ECS](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/userguide/scheduled_tasks.html)

# ä»–ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

ECS Scheduled Taskã‚’ä½¿ã£ã¦å®šæœŸå®Ÿè¡Œã™ã‚‹ãƒãƒƒãƒã‚’ä½œæˆã™ã‚‹å ´åˆã€Lambdaã‚„AWS Batchãªã©ä»–ã®å€™è£œã‚‚å‡ºã¦ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

Lambdaã¯å®Ÿè¡Œæ™‚é–“ã‚„ã€å®Ÿè¡Œãƒªã‚½ãƒ¼ã‚¹ã«åˆ¶é™ãŒã‚ã£ãŸã‚Šã—ã¾ã™ã€‚å®Ÿè¡Œæ™‚é–“ã¯15åˆ†ã¾ã§ã¨æ±ºã¾ã£ã¦ãŠã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€å®Ÿè¡Œæ™‚é–“ãŒ15åˆ†ä»¥ä¸Šã‹ã‹ã‚‹å‡¦ç†ã¯å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚å°è¦æ¨¡ãªãƒãƒƒãƒå‡¦ç†ã«æœ‰åŠ¹ã§ã™ã€‚

AWS Batchã¯å¤§è¦æ¨¡ãªãƒãƒƒãƒã‚„è¤‡æ•°ã®ãƒãƒƒãƒã‚’é€£æºã—ã¦å®Ÿè¡Œã•ã›ã‚‹éš›ã«æœ‰åŠ¹ãªæ‰‹æ®µã§ã™ã€‚

ãƒãƒƒãƒå‡¦ç†ã‚’ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã‹ã¤ã€ç°¡å˜ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨ã€è¨ˆç®—ç§‘å­¦ã‚„é‡‘èã‚µãƒ¼ãƒ“ã‚¹ãªã©ã§ã®æœ¬å½“ã«å¤§è¦æ¨¡ãªãƒãƒƒãƒå‡¦ç†ã§ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã§ã™ã€‚

ä»Šå›ã¯ã€Œä¸­è¦æ¨¡ãªãƒãƒƒãƒå‡¦ç†ã§ã€å®Ÿè¡Œæ™‚é–“ã¯15åˆ†å°‘ã—è¶…ãˆã‚‹ãã‚‰ã„ã€ã¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ãªã®ã§ã€Lambdaã‚„AWS Batchã¯ä½¿ç”¨ã›ãšã«ECS Scheduled Taskã‚’ä½¿ã£ã¦ãƒãƒƒãƒå‡¦ç†ã‚’ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ECSã®ä½œæˆ

ECSã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

èµ·å‹•ã‚¿ã‚¤ãƒ—ã¯Fargateã‚’ä½¿ã„ã€cpuã‚„ãƒ¡ãƒ¢ãƒªã«ã¤ã„ã¦ã¯ä»Šå›ã¯ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§ä¸€ç•ªä½ã„å€¤ï¼ˆcpuãŒ256ã€memoryãŒ512ï¼‰ã¨ã—ã¾ã™ã€‚

ECRã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã€ã‚¿ã‚¹ã‚¯å®šç¾©ã«ã¯ãƒªãƒã‚¸ãƒˆãƒªã®URIã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§è‰¯ã„ã¨ã—ã¾ã™ã€‚

## IAMãƒ­ãƒ¼ãƒ«

ã¾ãšã¯IAMãƒ­ãƒ¼ãƒ«ã§ã™ã€‚

### iam.tf

```go
resource "aws_iam_role" "ecs_role" {
  name               = "EcsTaskExecutionRole-sample"
  assume_role_policy = file("policies/ecs-task-assume-role.json")
}

resource "aws_iam_policy" "ecs_task_execution_policy" {
  name   = "EcsTaskExecutionPolicy-sample"
  policy = file("${path.module}/policies/ecs-task-execution-policy.json")
}

resource "aws_iam_role_policy_attachment" "task_execution_policy_attachment" {
  role       = aws_iam_role.ecs_role.name
  policy_arn = aws_iam_policy.ecs_task_execution_policy.arn
}
```

### policies/ecs-task-assume-role.json

```go
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### policies/ecs-task-execution-policy.json

CloudWatchã«ãƒ­ã‚°ã‚’åãå‡ºã™æ¨©é™ã¨ã€ECRã®FullAccessã¨åŒç­‰ã®æ¨©é™ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚

ï¼ˆFullAccessã¯ä¸è¦ãªæ¨©é™ã‚‚å…¥ã‚Œã¦ã—ã¾ã†ã®ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã‚ã¾ã‚Šã‚ˆããªã„ã§ã™ã€‚ã€‚ã€‚ï¼‰

```go
{
  "Version": "2012-10-17",
  "Statement": [
      {
          "Effect": "Allow",
          "Action": [
              "logs:CreateLogStream",
              "logs:PutLogEvents",

              "ecr:GetAuthorizationToken",
              "ecr:BatchCheckLayerAvailability",
              "ecr:GetDownloadUrlForLayer",
              "ecr:GetRepositoryPolicy",
              "ecr:DescribeRepositories",
              "ecr:ListImages",
              "ecr:DescribeImages",
              "ecr:BatchGetImage",
              "ecr:GetLifecyclePolicy",
              "ecr:GetLifecyclePolicyPreview",
              "ecr:ListTagsForResource",
              "ecr:DescribeImageScanFindings"
          ],
          "Resource": "*"
      }
  ]
}
```

## ã‚¿ã‚¹ã‚¯å®šç¾©

ã“ã“ã§ã€å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¿ã‚¹ã‚¯ã®å®šç¾©ã‚’ã—ã¦ã„ãã¾ã™ã€‚

ã“ã“ã§æŒ‡å®šã—ãŸæƒ…å ±ã‹ã‚‰EventBridgeãŒã‚¿ã‚¹ã‚¯ã‚’ç«‹ã¡ä¸Šã’ã¦ã€ãƒãƒƒãƒã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚

### task_def.tf

```go
resource "aws_ecs_task_definition" "task_def" {
  family                   = "ecs-scheduled-batch-task"
  network_mode             = "awsvpc"
  cpu                      = 256
  memory                   = 512
  requires_compatibilities = ["FARGATE"]
  container_definitions = file("./container_def/container_def.json")
  execution_role_arn = aws_iam_role.ecs_role.arn
  task_role_arn      = aws_iam_role.ecs_role.arn
}
```

### container_def/container_def.json

```json
[
  {
    "name": "<<Task Name>>",
    "image": "<<ECR Repository>>",
    "cpu": 256,
    "memory": 512,
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "/ecs/fargate-task-definition",
        "awslogs-region": "ap-northeast-1",
        "awslogs-stream-prefix": "ecs"
      }
    },
    "essential": true
  }
]
```

# EventBridgeã®ä½œæˆ

ç¶šã„ã¦ã€EventBridgeã®ä½œæˆã‚’ã—ã¦ã„ãã¾ã™ã€‚

å…ˆã»ã©ã¾ã§ã¯å®Ÿéš›ã«å®Ÿè¡Œã•ã‚Œã‚‹å´ã®å®šç¾©ã‚’ã—ã¦ãã¾ã—ãŸãŒã€ä»Šåº¦ã¯å®Ÿè¡Œã™ã‚‹å´ã®å®šç¾©ã‚’ã—ã¦ã„ãã¾ã™ã€‚

## IAMãƒ­ãƒ¼ãƒ«

å®Ÿè¡Œã™ã‚‹å´ã¯ã©ã‚“ãªã“ã¨ã‚’ã™ã‚‹ã‹ã€æ¨©é™ã‚’æ±ºã‚ã¦ã„ãã¾ã™ã€‚

åŸºæœ¬çš„ã«ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ãªã®ã§ã€RunTaskã®ã¿ã‚’æ¨©é™ã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

### iam.tf

æœ€åˆã«ä½œæˆã—ãŸiam.tfã®ç¶šãã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```go
resource "aws_iam_role" "events_role" {
  name               = "EcsEventsRole-sample"
  assume_role_policy = file("./policies/events-assume-role.json")
}

resource "aws_iam_policy" "events_policy" {
  name   = "EcsRunTaskEventsPolicy"
  policy = templatefile("./policies/events-policy.json", { task_definition_arn = aws_ecs_task_definition.task_def.arn })
}

resource "aws_iam_role_policy_attachment" "events_role_attachment" {
  role       = aws_iam_role.events_role.name
  policy_arn = aws_iam_policy.events_policy.arn
}
```

### policies/events-assume-role.json

```go
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "events.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### policies/events-policy.json

templateã®è¨˜æ³•ã‚’ä½¿ã£ã¦ã€tfãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰`task_definition_arn`ã¨ã„ã†å¤‰æ•°ã‚’å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯å…ˆã»ã©ä½œæˆã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã®ARNã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

å…ˆã»ã©ä½œæˆã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã®ã¿ã‚’RunTaskã§å®Ÿè¡Œã§ãã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```go
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "iam:PassRole",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "ecs:RunTask",
      "Resource": "${task_definition_arn}"
    }
  ]
}
```

## EventBridge

### events.tf

æœ€å¾Œã«EventBridgeã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

task_definition_arnã§å…ˆã»ã©ä½œæˆã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã®ARNã‚’æŒ‡å®šã—ã¾ã™ã€‚

ã¾ãŸã€å®Ÿéš›ã«ã©ã“ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‹ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®æŒ‡å®šã‚‚ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€aws_cloudwatch_event_targetã«ã¦ã€inputã§containerOverridesã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

ã“ã“ã§æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ãŒã‚¿ã‚¹ã‚¯èµ·å‹•æ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```go
resource "aws_cloudwatch_event_target" "scheduled_batch" {
  target_id = "hello"
  arn       = var.ecs_cluster_arn
  rule      = aws_cloudwatch_event_rule.scheduled_batch.name
  role_arn  = aws_iam_role.events_role.arn

  ecs_target {
    task_count             = 1
    task_definition_arn    = aws_ecs_task_definition.task_def.arn
    launch_type            = "FARGATE"
    platform_version       = "1.4.0"
    enable_execute_command = true
    network_configuration {
      subnets          = "<<Subnet ID>>"
      security_groups  = ["<<>Security Group ID>>"]
      assign_public_ip = true
    }
  }

  input = jsonencode(
    {
      containerOverrides = [
        {
          name    = "hello",
          command = ["echo", "Hello,World!"]
        }
      ]
    }
  )
}

resource "aws_cloudwatch_event_rule" "scheduled_batch" {
  name                = "hello"
  is_enabled          = true
  schedule_expression = "cron(*/30 * * * ? *)"
}
```

# å‹•ä½œç¢ºèª

å®Ÿéš›ã«AWSã«åæ˜ ã•ã›ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§åæ˜ ã•ã›ã¾ã™ã€‚

```go
terraform apply
```

EventBridgeã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä½œæˆã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ä¸­ã‚’ç¢ºèªã™ã‚‹ã¨ã€30åˆ†ã”ã¨ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/32a16f69c483-20231103.png)
![](https://storage.googleapis.com/zenn-user-upload/1833243802ec-20231103.png)


30åˆ†ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‚’å¾…ã¡ã¾ã™ã€‚

ãƒ­ã‚°ã¯CloudWatch Logsã«å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚CloudWatch Logsã«å‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

ç„¡äº‹å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼
![](https://storage.googleapis.com/zenn-user-upload/5dbe013b1085-20231103.png)

